LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_connect_module modules/mod_proxy_connect.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule ssl_module modules/mod_ssl.so

<VirtualHost *:80>
    ServerName marketplace.tlakepro.com

    # Redirect all HTTP traffic to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
</VirtualHost>

<VirtualHost *:80>
    ServerName admin.marketplace.tlakepro.com

    # Redirect all HTTP traffic to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
</VirtualHost>

<VirtualHost *:80>
    ServerName vendor.tlakepro.com

    # Redirect all HTTP traffic to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
</VirtualHost>

Listen 443
<VirtualHost *:443>
    ServerName backend.tlakepro.com

# Security headers
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/marketplace.tlakepro.com/cert.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/marketplace.tlakepro.com/privkey.pem
    SSLCertificateChainFile /etc/letsencrypt/live/marketplace.tlakepro.com/chain.pem

    # Proxy configuration
    ProxyPreserveHost On
    ProxyRequests Off

    <Location />
        ProxyPass http://mercurjs:9000/
        ProxyPassReverse http://mercurjs:9000/

        ProxyPassReverseCookieDomain mercurjs backend.marketplace.tlakepro.com
        RewriteEngine on
        RewriteCond %{HTTP:Upgrade} websocket [NC]
        RewriteCond %{HTTP:Connection} upgrade [NC]
        RewriteRule ^/?(.*) "ws://mercurjs:9000/$1" [P,L]
    </Location>
</VirtualHost>

<VirtualHost *:443>
    ServerName marketplace.tlakepro.com

# Security headers
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/marketplace.tlakepro.com/cert.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/marketplace.tlakepro.com/privkey.pem
    SSLCertificateChainFile /etc/letsencrypt/live/marketplace.tlakepro.com/chain.pem

    # Proxy configuration
    ProxyPreserveHost On
    ProxyRequests Off

    # Proxy all requests to Node.js on port 3001
    <Location />
        ProxyPass http://mercurjs:3001/
        ProxyPassReverse http://mercurjs:3001/

        ProxyPassReverseCookieDomain mercurjs marketplace.tlakepro.com
        RewriteEngine on
        RewriteCond %{HTTP:Upgrade} websocket [NC]
        RewriteCond %{HTTP:Connection} upgrade [NC]
        RewriteRule ^/?(.*) "ws://mercurjs:3001/$1" [P,L]
    </Location>
</VirtualHost>

<VirtualHost *:443>
    ServerName admin.marketplace.tlakepro.com

# Security headers
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/marketplace.tlakepro.com/cert.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/marketplace.tlakepro.com/privkey.pem
    SSLCertificateChainFile /etc/letsencrypt/live/marketplace.tlakepro.com/chain.pem

    # Proxy configuration
    ProxyPreserveHost On
    ProxyRequests Off

    # Proxy all requests to Node.js on port 3001
    <Location />
        ProxyPass http://mercurjs:9001/
        ProxyPassReverse http://mercurjs:9001/

        ProxyPassReverseCookieDomain mercurjs admin.marketplace.tlakepro.com
        RewriteEngine on
        RewriteCond %{HTTP:Upgrade} websocket [NC]
        RewriteCond %{HTTP:Connection} upgrade [NC]
        RewriteRule ^/?(.*) "ws://mercurjs:9001/$1" [P,L]
    </Location>
</VirtualHost>

<VirtualHost *:443>
    ServerName vendor.marketplace.tlakepro.com

# Security headers
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/marketplace.tlakepro.com/cert.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/marketplace.tlakepro.com/privkey.pem
    SSLCertificateChainFile /etc/letsencrypt/live/marketplace.tlakepro.com/chain.pem

    # Proxy configuration
    ProxyPreserveHost On
    ProxyRequests Off

    # Proxy all requests to Node.js on port 3001
    <Location />
        ProxyPass http://mercurjs:5173/
        ProxyPassReverse http://mercurjs:5173/

        ProxyPassReverseCookieDomain mercurjs vendor.marketplace.tlakepro.com
        RewriteEngine on
        RewriteCond %{HTTP:Upgrade} websocket [NC]
        RewriteCond %{HTTP:Connection} upgrade [NC]
        RewriteRule ^/?(.*) "ws://mercurjs:5173/$1" [P,L]
    </Location>
</VirtualHost>

